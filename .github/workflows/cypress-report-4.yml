name: Deploy Cypress Reports to GitHub Pages and Notify Slack

on:
  push:
    branches:
      - main  # Or the branch you run your Cypress tests from
  deployment_status:
    types: [success]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests
        run: npx cypress run

      - name: Save report with a unique identifier (timestamp)
        id: save_report
        run: |
          TIMESTAMP=$(date +"%Y%m%d%H%M%S")
          REPORT_DIR="cypress/reports/report-$TIMESTAMP"
          mkdir -p "$REPORT_DIR"
          cp -r cypress/reports/* "$REPORT_DIR"

      - name: Limit the number of reports to 5
        run: |
          report_dirs=$(ls -d cypress/reports/report-* | sort -r)
          report_count=$(echo "$report_dirs" | wc -l)
          if [ "$report_count" -gt 5 ]; then
            echo "$report_dirs" | tail -n +6 | xargs rm -rf
          fi

      - name: Deploy to gh-pages branch
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git fetch origin gh-pages
          git checkout gh-pages || git checkout --orphan gh-pages
          cp -r cypress/reports/* .
          git add .
          git commit -m "Deploy Cypress report"
          git push origin gh-pages

  notify-slack:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.event.deployment_status.state == 'success' && github.event.deployment_status.environment == 'github-pages'
    steps:
      - name: Get Latest Report URL
        id: get_pages_url
        run: echo "PAGES_URL=https://${{ github.repository_owner }}.github.io/${{ github.repository }}/report-${{ steps.save_report.outputs.REPORT_DIR }}/report.html" >> $GITHUB_ENV

      - name: Send Slack Notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PAGES_URL: ${{ env.PAGES_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data "{
            \"text\": \"The latest Cypress report has been deployed to GitHub Pages: $PAGES_URL\"
          }" $SLACK_WEBHOOK_URL